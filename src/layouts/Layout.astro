---
import "../styles/tailwind.css";
import "../styles/global.css";
import { Image } from "astro:assets";

import avatarImg from "../assets/images/avatar.JPG";

interface Project {
  title: string;
  link?: string;
}

interface Props {
  title: string;
  noParticles?: boolean;
  projects?: Project[];
}

const { title, noParticles = true, projects = [] } = Astro.props;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Preconnect for fonts (fast DNS/TLS) -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

    <!-- Google Fonts (non-blocking with display=swap) -->
    <link
      rel="preload"
      as="style"
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
      media="print"
      onload="this.media='all'"
    />
    <noscript>
      <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
        rel="stylesheet"
      />
    </noscript>

    <!-- Font Awesome (non-blocking) -->
    <link
      rel="preload"
      as="style"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
      rel="stylesheet"
      media="print"
      onload="this.media='all'"
    />
    <noscript>
      <link
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
        rel="stylesheet"
      />
    </noscript>

    <title>{title}</title>
  </head>

  <body
    class="font-inter
      bg-light text-text-main-light
      dark:bg-dark dark:text-text-main-dark
      transition-colors duration-300"
  >
    <!-- Particles -->
    {
      !noParticles && (
        <canvas
          id="particleCanvas"
          class="fixed top-0 left-0 w-full h-full z-0 pointer-events-none"
        />
      )
    }

    <!-- Sidebar (desktop only) -->
    <nav
      class="fixed top-14 left-0 h-[calc(100vh-3.5rem)] w-20 transition-all duration-300
            bg-light/80 dark:bg-dark/80 backdrop-blur-xl
            border-r border-gray-200 dark:border-gray-700
            hidden md:flex flex-col items-start py-6
            z-30"
      aria-label="Main navigation"
      id="main-nav"
    >
      <!-- Container to keep icons centered in the 80px width -->
      <div class="w-20 flex flex-col items-center">
        <!-- Avatar -->
        <Image
          src={avatarImg}
          alt="Sam Popham"
          width={48}
          height={48}
          loading="eager"
          class="rounded-full mb-8 border border-gray-300 dark:border-gray-600"
        />

        <!-- Links -->
        <a
          href="/"
          class="sidebar-link"
          data-home
          aria-label="Navigate to home"
        >
          <i class="fa-solid fa-house" aria-hidden="true"></i>
          <span>Home</span>
        </a>

        <a
          href="/#skills"
          class="sidebar-link"
          aria-label="Navigate to skills section"
        >
          <i class="fa-solid fa-layer-group" aria-hidden="true"></i>
          <span>Skills</span>
        </a>

        <a
          href="/#contact"
          class="sidebar-link"
          aria-label="Navigate to contact section"
        >
          <i class="fa-solid fa-envelope" aria-hidden="true"></i>
          <span>Contact</span>
        </a>

        <!-- Projects icon only -->
        <a
          href="/#projects"
          class="sidebar-link projects-link"
          data-projects-link
          aria-label="Navigate to projects section"
        >
          <i class="fa-solid fa-code" aria-hidden="true"></i>
          <span>Projects</span>
        </a>
      </div>

      <!-- Projects tree - outside the w-20 container to use full expanded width -->
      <div
        class="projects-wrapper"
        role="region"
        aria-label="Projects navigation"
      >
        <div
          class="projects-tree"
          id="projects-tree"
          role="navigation"
          aria-label="Individual projects"
        >
          {
            projects
              .filter((project) => project.link) // Only show projects with links
              .map((project) => {
                // Extract slug from link (e.g., "/projects/chess" -> "chess")
                const slug = project.link?.split("/").pop() || "";

                return (
                  <a
                    href={project.link}
                    class="tree-item"
                    data-project={slug}
                    data-tooltip={project.title}
                    aria-label={`View ${project.title} project`}
                    title={project.title}
                  >
                    {project.title}
                  </a>
                );
              })
          }
        </div>
      </div>
    </nav>

    <!-- Title bar -->
    <header
      class="sticky top-0 z-20 bg-light/85 dark:bg-dark/85 backdrop-blur-md border-b border-gray-200 dark:border-gray-700 transition-colors duration-300"
    >
      <div class="px-6 h-14 flex items-center justify-between">
        <h1 class="text-lg font-semibold">{title}</h1>

        <a
          href="/Sam_Popham_CV.pdf"
          download
          class="ml-4 inline-flex items-center px-3 py-1.5 rounded-md bg-blue-600 text-white text-sm font-medium hover:bg-blue-500 transition-colors duration-200"
          aria-label="Download CV as PDF"
        >
          <i class="fa-solid fa-download mr-2" aria-hidden="true"></i>
          Download CV
        </a>
      </div>
    </header>

    <!-- Page content -->
    <main class="relative z-10 md:ml-20">
      <slot />
    </main>

    {!noParticles && <script src="/scripts/particles.js" defer />}

    <script>
      // Select DOM elements
      const wrapper = document.querySelector(".projects-wrapper");
      const nav = document.getElementById("main-nav");
      const tree = document.querySelector("#projects-tree");
      const treeItems = document.querySelectorAll(".tree-item");
      const projectsLink = document.querySelector("[data-projects-link]");

      // --- HOVER LOGIC ---
      // Expand nav when hovering over the entire nav element
      nav?.addEventListener("mouseenter", () => {
        console.log("Nav mouseenter"); // Debug log
        nav?.classList.add("nav-expanded");
        wrapper?.classList.add("expanded");
      });

      nav?.addEventListener("mouseleave", () => {
        console.log("Nav mouseleave"); // Debug log
        // Always allow collapse when mouse leaves, even on project pages
        nav?.classList.remove("nav-expanded");
        wrapper?.classList.remove("expanded");
      });

      // --- CLICK LOGIC (Smooth Scroll) ---
      // Home icon - scroll to top
      const homeLink = document.querySelector("[data-home]");
      homeLink?.addEventListener("click", (e) => {
        if (window.location.pathname === "/") {
          e.preventDefault();
          window.scrollTo({
            behavior: "smooth",
            top: 0,
          });
        }
      });

      // Projects link - smooth scroll to projects section
      projectsLink?.addEventListener("click", (e) => {
        if (window.location.pathname === "/") {
          e.preventDefault();
          const projectsSection = document.getElementById("projects");
          projectsSection?.scrollIntoView({
            behavior: "smooth",
            block: "start",
          });
        }
      });

      // --- INITIALIZATION (Active State) ---
      function initializeProjectsState() {
        const path = window.location.pathname;

        // Check if we are currently viewing a project
        if (path.startsWith("/projects/")) {
          // Find and highlight the specific active project in the tree
          // But don't force the nav to stay expanded
          treeItems.forEach((item) => {
            const projectSlug = item.dataset.project;
            if (projectSlug && path.includes(projectSlug)) {
              item.classList.add("active");
            }
          });
        }
      }

      // Handle active link highlighting for standard links
      function updateActiveNavLink() {
        const currentPath = window.location.pathname;
        const currentHash = window.location.hash;

        // Only apply scrollspy on the homepage
        if (currentPath === "/" || currentPath === "/index.html") {
          // Don't use the hash-based approach, let scrollspy handle it
          return;
        }

        // For non-homepage, use the traditional approach
        document.querySelectorAll(".sidebar-link").forEach((link) => {
          const href = link.getAttribute("href");
          if (href === currentPath || href === currentPath + currentHash) {
            link.classList.add("text-blue-600", "dark:text-blue-400");
          } else {
            link.classList.remove("text-blue-600", "dark:text-blue-400");
          }
        });
      }

      // Scrollspy functionality for homepage
      function updateScrollSpy() {
        const currentPath = window.location.pathname;

        // Only run scrollspy on homepage
        if (currentPath !== "/" && currentPath !== "/index.html") {
          return;
        }

        const sections = [
          { id: "home", link: document.querySelector('[href="/"]') },
          { id: "skills", link: document.querySelector('[href="/#skills"]') },
          { id: "contact", link: document.querySelector('[href="/#contact"]') },
          {
            id: "projects",
            link: document.querySelector('[href="/#projects"]'),
          },
        ];

        // Get scroll position
        const scrollPosition = window.scrollY + 100; // Offset for better detection

        // Find which section we're in
        let currentSection = "home"; // Default to home

        for (const section of sections) {
          if (section.id === "home") continue; // Skip home, it's the default

          const element = document.getElementById(section.id);
          if (element) {
            const offsetTop = element.offsetTop;
            if (scrollPosition >= offsetTop) {
              currentSection = section.id;
            }
          }
        }

        // Update active states
        sections.forEach(({ id, link }) => {
          if (link) {
            if (id === currentSection) {
              link.classList.add("text-blue-600", "dark:text-blue-400");
            } else {
              link.classList.remove("text-blue-600", "dark:text-blue-400");
            }
          }
        });
      }

      // Event Listeners for Lifecycle
      document.addEventListener("DOMContentLoaded", () => {
        initializeProjectsState();
        updateActiveNavLink();
        updateScrollSpy();
      });

      window.addEventListener("hashchange", updateActiveNavLink);

      // Add scroll listener for scrollspy
      window.addEventListener("scroll", updateScrollSpy);

      // Update on resize (section positions might change)
      window.addEventListener("resize", updateScrollSpy);
    </script>
  </body>
</html>
